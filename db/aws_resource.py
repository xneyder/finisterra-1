# insert_resource.py
import os
from datetime import datetime
from dotenv import load_dotenv
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.dialects.postgresql import insert
from db.models import AwsResource, Base

# Load environment variables from .env file
load_dotenv()

# Get DATABASE_URL from environment variable
DATABASE_URL = os.environ["DATABASE_URL"]

engine = create_engine(DATABASE_URL)
Base.metadata.bind = engine

Session = sessionmaker(bind=engine)


def upsert_aws_resource(organization_id, provider, account_id, region, role, resource_type,
                        resource_name, resource_id, state_file, scanned_state_file, status,
                        autogenerated, description=None):
    session = Session()
    current_time = datetime.utcnow()

    # Prepare the upsert statement
    stmt = insert(AwsResource).values(
        organizationId=organization_id,
        provider=provider,
        accountId=account_id,
        region=region,
        role=role,
        resourceType=resource_type,
        resourceName=resource_name,
        resourceId=resource_id,
        stateFile=state_file,
        scannedStateFile=scanned_state_file,
        status=status,
        autogenerated=autogenerated,
        description=description,
        updatedAt=current_time

    ).on_conflict_do_update(
        index_elements=['accountId', 'resourceType', 'resourceId'],
        set_=dict(
            organizationId=organization_id,
            provider=provider,
            accountId=account_id,
            region=region,
            role=role,
            resourceType=resource_type,
            resourceName=resource_name,
            resourceId=resource_id,
            stateFile=state_file,
            scannedStateFile=scanned_state_file,
            status=status,
            autogenerated=autogenerated,
            description=description,
            updatedAt=current_time
        )
    )

    # Execute the upsert statement
    session.execute(stmt)

    # Commit the transaction
    session.commit()

    # Close the session
    session.close()
