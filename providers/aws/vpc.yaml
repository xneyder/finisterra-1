aws_vpc:
  # terraform_module: "terraform-aws-modules/aws/vpc"
  terraform_module: "../../../terraform-aws-modules/terraform-aws-vpc"
  terraform_module_version: "5.1.0"
  target_resource_name: this
  defaults:
    enable_dhcp_options: false
    create_igw: false

  fields:
    name:
      function: get_field_from_attrs
      arg: tags.name
      type: string
    cidr:
      field: cidr_block
      type: string
    ipv4_ipam_pool_id:
      field: ipv4_ipam_pool_id
      type: string
    ipv4_netmask_length:
      field: ipv4_netmask_length
      type: number
    ipv6_cidr:
      field: ipv6_cidr_block
      type: string
    ipv6_ipam_pool_id:
      field: ipv6_ipam_pool_id
      type: string
    ipv6_netmask_length:
      function: bigger_than_zero
      arg: ipv6_netmask_length
      type: number
    ipv6_cidr_block_network_border_group:
      field: ipv6_cidr_block_network_border_group
      type: string
    instance_tenancy:
      field: instance_tenancy
      type: string
    enable_dns_hostnames:
      field: enable_dns_hostnames
      type: bool
    enable_dns_support:
      field: enable_dns_support
      type: bool
    enable_network_address_usage_metrics:
      field: enable_network_address_usage_metrics
      type: bool
    tags:
      field: tags
      type: map
  childs:
    aws_default_route_table:
      join:
        id:
          field: vpc_id
      target_resource_name: default
      defaults:
        manage_default_route_table: true
      fields:
        default_route_table_propagating_vgws:
          field: propagating_vgws
          type: list
        default_route_table_route:
          field: route
          type: list
        default_route_table_tags:
          field: tags
          type: map
    aws_default_network_acl:
      join:
        id:
          field: vpc_id
      target_resource_name: this
      defaults:
        manage_default_network_acl: true
      fields:
        default_network_acl_egress:
          function: format_network_acl_rules
          arg: egress
          type: list
        default_network_acl_ingress:
          function: format_network_acl_rules
          arg: ingress
          type: list
        default_network_acl_tags:
          field: tags
          type: map
    aws_default_security_group:
      join:
        id:
          field: vpc_id
      target_resource_name: this
      defaults:
        manage_default_security_group: true
      fields:
        default_security_group_egress:
          function: format_egress_rules
          type: list
        default_security_group_ingress:
          function: format_ingress_rules
          type: list
        default_security_group_tags:
          field: tags
          type: map

    aws_subnet_public:
      resource_type: aws_subnet
      join:
        id:
          field: vpc_id
      skip_if:
        function: is_subnet_private
        arg: vpc_id
      second_index:
        function: get_subnet_index_public
        arg: id
      target_resource_name: public
      fields:
        public_subnet_assign_ipv6_address_on_creation:
          field: assign_ipv6_address_on_creation
          type: bool
        azs:
          function: to_array
          arg: availability_zone
          type: list
        public_subnets:
          function: to_array
          arg: cidr_block
          type: list
        public_subnet_enable_dns64:
          field: enable_dns64
          type: bool
        public_subnet_enable_resource_name_dns_aaaa_record_on_launch:
          field: enable_resource_name_dns_aaaa_record_on_launch
          type: bool
        public_subnet_enable_resource_name_dns_a_record_on_launch:
          field: enable_resource_name_dns_a_record_on_launch
          type: bool
        public_subnet_ipv6_native:
          field: ipv6_native
          type: bool
        map_public_ip_on_launch:
          field: map_public_ip_on_launch
          type: bool
        public_subnet_private_dns_hostname_type_on_launch:
          field: private_dns_hostname_type_on_launch
          type: string
        public_subnet_tags_per_az:
          function: build_tags_per_az
          type: map
      childs:
        aws_route_table_association:
          join:
            id:
              field: subnet_id
          target_resource_name: public
          second_index:
            function: get_subnet_index_public
            arg: subnet_id
          childs:
            aws_route_table:
              join:
                route_table_id:
                  field: id
              target_resource_name: public
        aws_nat_gateway:
          join:
            id:
              field: subnet_id
          target_resource_name: this
          defaults:
            enable_nat_gateway: true
          second_index:
            field: id
          fields:
            nat_gateways:
              function: build_dict_var
              arg: id
              type: map
          childs:
            aws_eip:
              join:
                allocation_id:
                  field: allocation_id
              target_resource_name: nat
              second_index:
                field: allocation_id
              fields:
                eips:
                  function: build_dict_var
                  arg: allocation_id
                  type: map
            aws_route:
              join:
                id:
                  field: nat_gateway_id
              target_resource_name: private_nat_gateway
              second_index:
                field: id
              fields:
                nat_gateway_routes:
                  function: build_dict_var
                  arg: id
                  type: map

    aws_subnet_private:
      resource_type: aws_subnet
      join:
        id:
          field: vpc_id
      skip_if:
        function: is_subnet_public
        arg: vpc_id
      second_index:
        function: get_subnet_index_private
        arg: id
      target_resource_name: private
      fields:
        private_subnet_assign_ipv6_address_on_creation:
          field: assign_ipv6_address_on_creation
          type: bool
        azs:
          function: to_array
          arg: availability_zone
          type: list
        private_subnets:
          function: to_array
          arg: cidr_block
          type: list
        private_subnet_enable_dns64:
          field: enable_dns64
          type: bool
        private_subnet_enable_resource_name_dns_aaaa_record_on_launch:
          field: enable_resource_name_dns_aaaa_record_on_launch
          type: bool
        private_subnet_enable_resource_name_dns_a_record_on_launch:
          field: enable_resource_name_dns_a_record_on_launch
          type: bool
        private_subnet_ipv6_native:
          field: ipv6_native
          type: bool
        private_subnet_private_dns_hostname_type_on_launch:
          field: private_dns_hostname_type_on_launch
          type: string
        private_subnet_tags_per_az:
          function: build_tags_per_az
          type: map
      childs:
        aws_route_table_association:
          join:
            id:
              field: subnet_id
          target_resource_name: private
          second_index:
            function: get_subnet_index_private
            arg: subnet_id
          childs:
            aws_route_table:
              join:
                route_table_id:
                  field: id
              target_resource_name: private
              second_index:
                function: get_aws_route_id_private
                arg: id

    aws_internet_gateway:
      join:
        id:
          field: vpc_id
      target_resource_name: this
      defaults:
        create_igw: true
      fields:
        igw_tags:
          field: tags
          type: map
      childs:
        aws_route:
          join:
            id:
              field: gateway_id
          target_resource_name: public_internet_gateway
