aws_instance:
  # terraform_module: "../../../terraform-aws-modules/terraform-aws-ec2-instance"
  terraform_module: "github.com/finisterra-io/terraform-aws-modules.git//ec2?ref=main"
  terraform_module_version: "5.3.0"
  target_resource_name: default
  # path: "ec2"
  joined_fields:
    security_groups:
      sub_fields:
        - security_groups
    device_name_list:
      sub_fields:
        - kms_key_id
    instance_profile:
      sub_fields:
        - instance_profile
  fields:
    # ec2_init_fields:
    #   function: ec2_init_fields
    ami:
      field: ami
      type: string
    availability_zone:
      field: availability_zone
      type: string
    instance_type:
      field: instance_type
      type: string
    ebs_optimized:
      field: ebs_optimized
      type: bool
      module_default: true
    disable_api_termination:
      field: disable_api_termination
      type: bool
      module_default: false
    user_data:
      function: ec2_get_user_data
      arg: id
      type: string
      multiline: true
      jsonfield: false
    user_data_base64:
      field: user_data_base64
      type: string
    instance_profile:
      field: iam_instance_profile
      type: string
    instance_initiated_shutdown_behavior:
      field: instance_initiated_shutdown_behavior
      type: string
    associate_public_ip_address:
      field: associate_public_ip_address
      type: bool
      module_default: false
    ssh_key_pair:
      field: key_name
      type: string
    subnet_name:
      function: get_subnet_name_ec2
      arg: id
      type: string
    subnet_id:
      function: get_subnet_id_ec2
      arg: id
      type: string
    monitoring:
      field: monitoring
      type: bool
      module_default: true
    private_ip:
      field: private_ip
      type: string
    secondary_private_ips:
      field: secondary_private_ips
      type: list
    source_dest_check:
      field: source_dest_check
      type: bool
      module_default: true
    ipv6_address_count:
      field: ipv6_address_count
      type: number
      module_default: 0
    # ipv6_addresses:
    #   field: ipv6_addresses
    #   type: list
    tenancy:
      field: tenancy
      type: string
    security_groups:
      field: vpc_security_group_ids
      type: list
    external_network_interfaces:
      field: network_interface
      type: list
    root_volume_type:
      function: get_field_from_attrs
      arg: root_block_device.volume_type
      type: string
      module_default: gp2
    root_volume_size:
      function: get_field_from_attrs
      arg: root_block_device.volume_size
      type: number
      module_default: 10
    root_iops:
      function: get_field_from_attrs
      arg: root_block_device.iops
      type: number
      module_default: 0
    root_throughput:
      function: get_field_from_attrs
      arg: root_block_device.throughput
      type: number
      module_default: 0
    delete_on_termination:
      function: get_field_from_attrs
      arg: root_block_device.delete_on_termination
      type: bool
      module_default: true
    root_block_device_encrypted:
      function: get_field_from_attrs
      arg: root_block_device.encrypted
      type: bool
      module_default: true
    root_block_device_kms_key_id:
      function: get_kms_key_id_ec2
      arg: root_block_device.kms_key_id
      type: string
    root_block_device_kms_key_alias:
      function: get_kms_key_alias_ec2
      arg: root_block_device.kms_key_id
      type: string
    root_block_device_tags:
      function: get_field_from_attrs
      arg: root_block_device.tags
      type: map
    metadata_http_endpoint:
      function: get_field_from_attrs
      arg: metadata_options.http_endpoint
      type: string
      module_default: enabled
    metadata_http_protocol_ipv6:
      function: get_field_from_attrs
      arg: metadata_options.http_protocol_ipv6
      type: string
      module_default: disabled
    metadata_instance_metadata_tags:
      function: get_field_from_attrs
      arg: metadata_options.instance_metadata_tags
      type: list
      module_default: enabled
    metadata_http_put_response_hop_limit:
      function: get_field_from_attrs
      arg: metadata_options.http_put_response_hop_limit
      type: number
      module_default: 2
    metadata_http_tokens:
      function: get_field_from_attrs
      arg: metadata_options.http_tokens
      type: string
      module_default: required
    burstable_mode:
      function: get_field_from_attrs
      arg: credit_specification.cpu_credits
      type: string
    tags:
      field: tags
      type: map
    volume_tags:
      field: volume_tags
      type: map
    launch_template:
      field: launch_template
      type: list
  childs:
    aws_volume_attachment:
      join:
        id:
          field: instance_id
      target_resource_name: default
      second_index:
        field: device_name
      childs:
        aws_ebs_volume:
          join:
            volume_id:
              field: id
          target_resource_name: default
          second_index:
            function: ec2_get_device_name
          fields:
            device_name_list:
              function: ec2_get_device_name_list
              type: map
    aws_eip:
      join:
        id:
          field: instance
      # defaults:
      # assign_eip_address: true
      second_index:
        field: public_ip
      target_resource_name: default
      fields:
        public_ip_addresses:
          function: ec2_get_public_ip_addresses
          type: map
          arg: id

    # aws_network_interface_attachment:
    #   join:
    #     id:
    #       field: instance_id
    #   target_resource_name: additional
    #   second_index:
    #     function: ec2_get_device_index
    #   fields:
    #     additional_ips_count:
    #       function: ec2_get_additional_ips_count
    #       type: number
