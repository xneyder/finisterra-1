aws_rds_cluster:
  # terraform_module: "../../../terraform-aws-modules/terraform-aws-rds-aurora"
  terraform_module: "github.com/finisterra-io/terraform-aws-rds-aurora.git?ref=main"
  terraform_module_version: "6.1.0"
  target_resource_name: this
  name_field: cluster_identifier
  # path: "aurora"
  # dependencies:
  #   - "../iam_role"
  defaults:
    create_db_subnet_group: false
    manage_master_user_password: false
    create_security_group: false
  fields:
    init:
      function: init_cluster_attributes
    allocated_storage:
      field: allocated_storage
      type: number
    availability_zones:
      field: availability_zones
      type: list
    backup_retention_period:
      field: backup_retention_period
      type: number
    backtrack_window:
      field: backtrack_window
      type: number
    cluster_identifier:
      field: cluster_identifier
      type: string
    # cluster_identifier_prefix:
    #   field: identifier_prefix
    #   type: string
    cluster_members:
      field: cluster_members
      type: list
    copy_tags_to_snapshot:
      field: copy_tags_to_snapshot
      type: bool
    database_name:
      field: database_name
      type: string
    instance_class:
      field: db_cluster_instance_class
      type: string
    db_cluster_parameter_group_name:
      field: db_cluster_parameter_group_name
      type: string
    db_cluster_db_instance_parameter_group_name:
      field: db_instance_parameter_group_name
      type: string
    allow_major_version_upgrade:
      field: allow_major_version_upgrade
      type: bool
    db_subnet_group_name:
      field: db_subnet_group_name
      type: string
    deletion_protection:
      field: deletion_protection
      type: bool
    enable_global_write_forwarding:
      field: enable_global_write_forwarding
      type: bool
    enabled_cloudwatch_logs_exports:
      field: enabled_cloudwatch_logs_exports
      type: list
    enable_http_endpoint:
      field: enable_http_endpoint
      type: bool
    engine:
      field: engine
      type: string
    engine_mode:
      field: engine_mode
      type: string
    engine_version:
      field: engine_version
      type: string
    final_snapshot_identifier:
      field: final_snapshot_identifier
      type: string
    global_cluster_identifier:
      field: global_cluster_identifier
      type: string
    iam_database_authentication_enabled:
      field: iam_database_authentication_enabled
      type: bool
    iops:
      field: iops
      type: number
    kms_key_id:
      field: kms_key_id
      type: string
    manage_master_user_password:
      field: manage_master_user_password
      type: bool
    master_user_secret_kms_key_id:
      field: master_user_secret_kms_key_id
      type: string
    master_username:
      field: master_username
      type: string
    network_type:
      field: network_type
      type: string
    port:
      field: port
      type: number
    preferred_backup_window:
      field: preferred_backup_window
      type: string
    preferred_maintenance_window:
      field: preferred_maintenance_window
      type: string
    replication_source_identifier:
      field: replication_source_identifier
      type: string
    restore_to_point_in_time:
      field: restore_to_point_in_time
      type: list
    s3_import:
      field: s3_import
      type: map
    scaling_configuration:
      field: scaling_configuration
      type: map
    serverlessv2_scaling_configuration:
      field: serverlessv2_scaling_configuration
      type: map
    skip_final_snapshot:
      field: skip_final_snapshot
      type: bool
    snapshot_identifier:
      field: snapshot_identifier
      type: string
    source_region:
      field: source_region
      type: string
    storage_encrypted:
      field: storage_encrypted
      type: bool
    storage_type:
      field: storage_type
      type: string
    tags:
      field: tags
      type: map
    vpc_security_group_ids:
      field: vpc_security_group_ids
      type: list
    auto_minor_version_upgrade:
      field: auto_minor_version_upgrade
      type: bool
  childs:
    aws_appautoscaling_target:
      join:
        arn:
          function: build_resource_id
      target_resource_name: this
      defaults:
        autoscaling_enabled: true
      fields:
        scalable_dimension:
          field: scalable_dimension
          type: string
        min_capacity:
          field: min_capacity
          type: number
        autoscaling_max_capacity:
          field: max_capacity
          type: number
        service_namespace:
          field: service_namespace
          type: string
    aws_appautoscaling_policy:
      join:
        arn:
          function: build_resource_id
      target_resource_name: this
      defaults:
        autoscaling_enabled: true
      fields:
        appautoscaling_policy_name:
          field: name
          type: string
        autoscaling_policy_type:
          field: policy_type
          type: string
        predefined_metric_type:
          function: get_field_from_attrs
          arg: target_tracking_scaling_policy_configuration.predefined_metric_specification.predefined_metric_type
          type: string
        autoscaling_scale_in_cooldown:
          function: get_field_from_attrs
          arg: target_tracking_scaling_policy_configuration.scale_in_cooldown
          type: number
        autoscaling_scale_out_cooldown:
          function: get_field_from_attrs
          arg: target_tracking_scaling_policy_configuration.scale_out_cooldown
          type: number
        autoscaling_target_cpu:
          function: get_field_from_attrs
          arg: target_tracking_scaling_policy_configuration.target_value
          type: number
        autoscaling_target_connections:
          function: get_field_from_attrs
          arg: target_tracking_scaling_policy_configuration.target_value
          type: number
    aws_rds_cluster_endpoint:
      join:
        cluster_identifier:
          field: cluster_identifier
      target_resource_name: this
      second_index:
        field: cluster_endpoint_identifier
      fields:
        cluster_endpoint:
          function: build_cluster_endpoint
          type: map
    aws_rds_cluster_role_association:
      join:
        cluster_identifier:
          field: cluster_identifier
      target_resource_name: this
      second_index:
        field: cluster_endpoint_identifier
      fields:
        cluster_endpoint:
          function: build_cluster_role_association
          type: map
    aws_rds_cluster_instance:
      join:
        cluster_identifier:
          field: cluster_identifier
      target_resource_name: this
      second_index:
        function: get_instance_identifier
      fields:
        instances:
          function: build_instances
          type: map
      childs:
        aws_cloudwatch_log_group:
          join:
            identifier:
              function: cloudwatch_log_group_name
          target_resource_name: this
          defaults:
            create_cloudwatch_log_group: true
          second_index:
            function: get_log_group_name
          fields:
            cloudwatch_log_group_retention_in_days:
              field: retention_in_days
              type: number
              module_default: 7
            cloudwatch_log_group_kms_key_id:
              field: kms_key_id
              type: string
        aws_db_subnet_group:
          join:
            db_subnet_group_name:
              field: name
          target_resource_name: this
          defaults:
            db_subnet_group_use_name_prefix: false
          fields:
            create_db_subnet_group:
              unique: true
            db_subnet_group_name:
              field: name
              type: string
            subnets:
              field: subnet_ids
              type: list
            db_subnet_group_tags:
              field: tags
              type: map
            db_subnet_group_description:
              field: description
              type: string
        aws_db_parameter_group:
          join:
            parameter_group_name:
              field: name
          target_resource_name: this
          defaults:
            parameter_group_use_name_prefix: false
          fields:
            create_db_parameter_group:
              unique: true
            db_cluster_parameter_group_name:
              field: name
              type: string
            db_parameter_group_family:
              field: family
              type: string
            db_parameter_group_description:
              field: description
              type: string
            db_parameter_group_tags:
              field: tags
              type: map
            db_parameter_group_parameters:
              field: parameters
              type: map

aws_iam_role:
  # terraform_module: "../../../terraform-aws-modules/terraform-aws-iam//modules/iam_role"
  terraform_module: "github.com/finisterra-io/terraform-aws-iam//modules/iam_role?ref=main"
  terraform_module_version: "5.2.0"
  target_resource_name: default
  name_field: role_name
  # path: "iam_role"
  # dependencies:
  #   - "../iam_policy"
  fields:
    role_name:
      field: name
      type: string
    assume_role_policy:
      field: assume_role_policy
      type: string
      multiline: true
    role_description:
      field: description
      type: string
    max_session_duration:
      field: max_session_duration
      type: number
    inline_policies:
      function: get_inline_policies
      type: list
    permissions_boundary:
      field: permissions_boundary
      type: string
    path:
      field: path
      type: string
    tags:
      field: tags
      type: map
    managed_policy_arns:
      field: managed_policy_arns
      type: list
  childs:
    aws_iam_role_policy_attachment:
      join:
        name:
          field: role
      target_resource_name: managed
      second_index:
        function: get_policy_attachment_index
    aws_iam_instance_profile:
      join:
        name:
          field: role
      target_resource_name: default
      second_index:
        field: name
      fields:
        instance_profiles:
          function: get_instance_profiles
          type: list

aws_iam_policy:
  # terraform_module: "../../../terraform-aws-modules/terraform-aws-iam//modules/iam_policy"
  terraform_module: "github.com/finisterra-io/terraform-aws-iam//modules/iam_policy?ref=main"
  terraform_module_version: "5.2.0"
  target_resource_name: default
  name_field: policy_name
  # path: "iam_policy"
  fields:
    policy_documents:
      function: get_policy_documents
      type: string
      multiline: true
    policy_name:
      field: name
      type: string
    policy_description:
      field: description
      type: string
    path:
      field: path
      type: string
    tags:
      field: tags
      type: map
