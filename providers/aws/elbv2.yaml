aws_lb:
  # terraform_module: "../../../terraform-aws-modules/terraform-aws-alb"
  terraform_module: "github.com/finisterra-io/terraform-aws-alb.git?ref=main"
  terraform_module_version: "0.20.0"
  target_resource_name: default
  name_field: load_balancer_name
  defaults:
    enabled: true
    create_security_group: false
  # path: "alb"
  # dependencies:
  #   - "../security_group"
  fields:
    init:
      function: init_fields
      type: string
    load_balancer_name:
      field: name
      type: string
    load_balancer_type:
      field: load_balancer_type
      type: string
    tags:
      field: tags
      type: map
    internal:
      field: internal
      type: bool
      module_default: false
    security_group_names:
      function: get_security_group_names
      arg: security_groups
      type: list
    cross_zone_load_balancing_enabled:
      field: enable_cross_zone_load_balancing
      type: bool
      module_default: true
    http2_enabled:
      field: enable_http2
      type: bool
      module_default: true
    idle_timeout:
      field: idle_timeout
      type: number
      module_default: 60
    ip_address_type:
      field: ip_address_type
      type: string
      module_default: "ipv4"
    deletion_protection_enabled:
      field: enable_deletion_protection
      type: bool
      module_default: false
    drop_invalid_header_fields:
      field: drop_invalid_header_fields
      type: bool
      module_default: false
    preserve_host_header:
      field: preserve_host_header
      type: bool
      module_default: false
    xff_header_processing_mode:
      field: xff_header_processing_mode
      type: string
      module_default: "append"
    access_logs:
      field: access_logs
      type: map
    vpc_name:
      function: get_vpc_name_elbv2
      type: string
      arg: vpc_id
    vpc_id:
      function: get_vpc_id_elbv2
      type: string
      arg: vpc_id
    subnet_names:
      function: get_subnet_names
      arg: subnets
      type: list
    subnet_ids:
      function: get_subnet_ids
      arg: subnets
      type: list
    enable_xff_client_port:
      field: enable_xff_client_port
      type: bool

  childs:
    aws_lb_listener:
      join:
        arn:
          field: load_balancer_arn
      target_resource_name: this
      second_index:
        function: get_port
      fields:
        aws_lb_listeners:
          function: get_listeners
          type: map
      childs:
        aws_lb_listener_certificate:
          join:
            arn:
              field: listener_arn
          target_resource_name: https_sni
          second_index:
            function: get_port_domain_name
          fields:
            aws_lb_listeners:
              function: get_listener_certificate
              type: map

aws_security_group:
  # terraform_module: "../../../terraform-aws-modules/terraform-aws-security-group"
  terraform_module: "github.com/finisterra-io/terraform-aws-security-group?ref=main"
  terraform_module_version: "5.2.0"
  target_resource_name: default
  name_field: security_group_name
  add_id_hash_to_name: true
  # path: "security_group"
  defaults:
    create_before_destroy: false
  fields:
    security_group_name:
      field: name
      type: string
    vpc_name:
      function: get_vpc_name
      arg: vpc_id
      type: string
    vpc_id:
      function: get_vpc_id
      type: string
      arg: vpc_id
    security_group_description:
      field: description
      type: string
    tags:
      field: tags
      type: map
  childs:
    aws_vpc_security_group_ingress_rule:
      join:
        id:
          field: security_group_id
      import_id:
        field: security_group_rule_id
      target_resource_name: dbc
      second_index:
        field: id
      fields:
        ingress_rules:
          function: get_security_group_rules
          type: map
    aws_vpc_security_group_egress_rule:
      join:
        id:
          field: security_group_id
      import_id:
        field: security_group_rule_id
      target_resource_name: dbc
      second_index:
        field: id
      fields:
        egress_rules:
          function: get_security_group_rules
          type: map
